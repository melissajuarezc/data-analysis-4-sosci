---
title: "Lab 06 -- Data Analysis"
author: "Melissa Juarez"
date: "April 08, 2023"
output:
  html_document: default
---

```{r include=FALSE}
library(here)
library(tidyverse)
library(janitor)
library(plyr)
library(dplyr)

## read data
panel_data <- read.csv(here::here("data/panel-for-R.csv"))

```

```{r funs, include=FALSE}
# from TA recitation code lab 6
clusterSE <- function(fit, cluster.var, data){ # note: cluster.var should be entered as character string
  require(plm); require(lmtest)
  
  if (missing(data) & cluster.var %in% colnames(index(fit))){
    cvar <- index(fit, cluster.var)
    n <- length(unique(cvar))
    N <- length(cvar)
  }
  else{
    row.ids <- as.numeric(rownames(model.frame(fit)))
    # 1. get number of clusters (omitting individuals with missingness on "divorce.easier" and/or "divorced")
    n <- length(unique(data[row.ids, cluster.var]))
    # 2. get number of observations (again omitting the same individuals with missingness)
    N <- length(row.ids) 
  }
  
  #3. compute degrees of freedom
  df <- (n/(n - 1)) * (N - 1)/fit$df.residual
  # compute variance-covariance matrix
  vcov <- df*vcovHC(fit, type = "HC0", cluster = "group")
  # retest coefficients  
  coeftest(fit, vcov = vcov)
}

```


##### Q1: Run a naive ("pooled") OLS regression on the panel data.  Tell we how you expect your Xs to affect your Y and why.  Apply clustered standard errors too.  Interpret your results.

In this problem, I look at the association between the following variables in a naive OLS regression model:

-   `happy`: This is a ordinal categorical variable relating to the question: Taken all together, how would you say things are these days -- would you say that you are very happy, pretty happy, or not too happy?" In the original dataset, 1 means Very Happy and 3 means Not so Happy.  I will recode the variable so that 1 means not so happy and 3 means very happy.

-   `health`: This is an ordinal categorical variable relating to the question: "Would you say your own health, in general, is excellent, good, fair, or poor? " 1 indicates the the person has Excellent health, whereas a 4 indicates that a person has poor health. I will recode the variable for 1 to mean poor health and 4 to mean excellent health.
    
-   `class`: This is an ordinal categorical variable relating to the question: "If you were asked to use one of four names for your social class, which would you say you belong in: the lower class, the working class, the middle class, or the upper class?" 1 indicates that the respondent places themselves in the lower class whereas 4 indicates that the person is Upper class.

I expect that as respondent's health gets better (class held constant), their happiness will increase, due to their better quality of life. Additionally, I expect that as class increases (health held constant), a persons happiness will also increase.

```{r q1, message=FALSE, warning=FALSE}
panel_data_sub <- panel_data %>%
  mutate(happy = case_when(
    happy == 1 ~ 3, # very happy
    happy == 3 ~ 1, # not so happy
  ), health = case_when(
    health == 1 ~ 4, # Excellent Health
    health == 2 ~ 3,
    health == 3 ~ 2,
    health == 4 ~ 1, # Extreme Conservative
  )) %>%
  select(idnum, panelwave, health, class, happy)

m1 <- lm(happy ~ health + class, data = panel_data_sub)
summary(m1)

clusterSE(fit = m1, cluster.var = "idnum", data = panel_data_sub)

```

In the output above, we have the estimated model 
$$
\widehat{\text{happy}} = 0.788 + 0.338\text{health} + 0.238\text{class}
$$.

We can interpret the model in the following way:

-   Intercept: At the base level when health = 0 and class = 0, respondents are expected be at 0.788 *** level of happiness, indictatng the person is less than 'Not so Happy'.

-   `health`: Class held constant, for every 1 level increase of health, there is an expected 0.338 *** level increase in happiness.

-   `class`: Health held constant, for every 1 level increase in class, there is an expected 0.238 *** level increase in class.

This model fit my expectations, seeing as the coefficients for `health` and `class` are positive. Additionally, using the output from the clusterSE function, we see that all regressor coefficients are statistically significant.


##### Q2: Run a first differences regression on the same model in Question 1.  Interpret your results.  Do you draw a different conclusion than in Question 1?  Explain.

```{r q2}

m2 <- plm(happy ~ health + class,  index = c("idnum", "panelwave"),  model = "fd", data = panel_data_sub)

summary(m2)

```
In the output above, we have the estimated model 
$$
\widehat{\Delta\text{happy}} = -0.076 + 0.186\Delta\text{health} - 0.052\Delta\text{class}
$$.

We can interpret the model in the following way:

-   Intercept: At the base level when health = 0 and class = 0, respondents are expected be at see a change of -0.076 ** levels of happiness, indicating a decrease in baseline happiness across the panel waves.

-   `health`: Class held constant, a increase in 1 level of health leads to an expected 0.186 *** level increase in happiness, indicating an increase in happiness as a result of increase in health.

-   `class`: Health held constant, a increase in 1 level of class leads to an expected 0.05 (n.s.) level decrease in happiness. This relationship is not significant.

This model produces different results than in model one for the class variable. The FD model shows that there is no causal relationship between class and happiness, while our linear model showed that there is a significant relationship between two. For the health variable, the FD model showed that change in health outcomes leads to changes in happiness outcomes, and the linear model shows that there is a significant relationship between the two.
